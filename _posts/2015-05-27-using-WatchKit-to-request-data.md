---
layout: post
title:  "Challenges using WatchKit to request data for the Apple Watch"
date:   2015-05-27 06:39:00
categories: dev
comments: on
---

I'd been struggling for a couple of hours to understand why I was unable to pass a `UIColor` object back to the Apple Watch when I found myself wondering if I'd identified a bug in WatchKit. Whilst Apple is far from perfect, it was unlikely I'd discovered a bug in WatchKit. But equally, I couldn't find anyone else suffering from the same issue. A trawl of StackOverflow revealed nothing. So I set out to understand.

Passing an `NSDictionary` of various objects between the watch and the phone was working flawlessly until I decided to include a `UIColor` in one of the elements. The moment I did that, the watch would appear to receive `nil`. With the inclusion of `UIColor` objects, the whole dictionary was passed as `nil` without a single error message. What could I be doing wrong?

My mistakes:

 - Assuming that `[NSObject: AnyObject]` genuinely meant *any object*
 - Skim reading the documentation and examples instead of understanding what I was doing
 - Not appreciating quite how the debugger works with WatchKit extensions

I eventually cracked it and this post is an explanation of the misunderstandings I had which led to my issue. Documenting this helped me to crack the issue. Hopefully sharing it will help others.

## Passing a String - It Works!

{% gist billglover/692bcafeceae88a471fb %}

{% gist billglover/e02b61da5d1cc8dd1fff %}

The console output is as we'd expect.

```
response: this is the response
```

If you want to try this out for yourself, a working project is available on GitHub: [WatchKitDemo](https://github.com/billglover/WatchKitDemo "WatchKitDemo on GitHub").

## Passing a UIColor - It Doesn't!

{% gist billglover/81477e0fb4bc43069f70 %}

{% gist billglover/ce697e10eda3c6be8a8a %}

The console output doesn't show any errors, but it's also not what we were hoping to see.

```
response received but not recognised
```

It wasn't until I included a `UIColor` as part of the initial request that I was given some indication as to what was going wrong.

```
2015-05-27 21:55:05.897 WatchKitDemo WatchKit Extension[76878:4862115] Property list invalid for format: 200 (property lists cannot contain objects of type 'CFType')
2015-05-27 21:55:05.898 WatchKitDemo WatchKit Extension[76878:4862115] Unable to serialize userInfo {
    request = "UIDeviceWhiteColorSpace 0 1";
}. Got Error (null)
```

That was the clue I needed. For some reason, Swift was having trouble serialising the `UIColor` object. 

The `replyInfo` should be of type `[NSObject: AnyObject]` and so my first inclination was to check that `UIColor` was indeed an `AnyObject`. The [UIColor Class Reference](https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIColor_Class/index.html#//apple_ref/occ/cl/UIColor "UIColor Class Reference") confirms it is.

But it turns out, conforming to the right type isn't enough. Reading further on in the documentation reveals why. The emphasis in the extracts below is mine.

### userInfo

> A dictionary containing data to pass to the iOS app. Use this dictionary to pass information to the iOS app so that it can perform any needed tasks. **The contents of the dictionary must be serializable to a property list file.** This parameter must not be nil.

Source: [Communicating with the Parent iOS App](https://developer.apple.com/library/ios/documentation/WatchKit/Reference/WKInterfaceController_class/#//apple_ref/occ/clm/WKInterfaceController/openParentApplication:reply: "iOS Developer Library")

### replyInfo

> A dictionary containing data to return to the WatchKit app. **The contents of the dictionary must be serializable to a property list file.** The contents of this dictionary are at your discretion and you may specify nil.

Source: [Responding to WatchKit Requests](https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIApplicationDelegate_Protocol/#//apple_ref/occ/intfm/UIApplicationDelegate/application:handleWatchKitExtensionRequest:reply: "iOS Developer Library")

The documentation clearly states that these dictionaries also have to be serializeable to property lists. But it also states (elsewhere) that `UIColor` is not serializable in this way.

## The Console Mystery

The lack of a console error message in our earlier example is not such a mystery after all once you realise that the WatchKitDemo app and the WatchKitDemo extension run in separate processes. The debugger can connect to both, but by default it only connects to the WatchKitDemo extension. Our console output was being generated by the app and so invisible to the extension debugger.

![The debugger connected to both the app and extension](/assets/WatchKitDemoDebugger.png)
{: style="text-align: center;"}

When the debugger is connected to both the app and the extension it does a fairly good job of displaying the most appropriate output. But, as I've found, it is easy to get confused.

## The Solution

The solution was relatively simple. I passed the RGBa values as `Double`s and used those to instantiate a `UIColor`. But I do wonder whether the compiler should have known that `UIColor` was not serializeable to a property list and therefore flagged this at compile time. It's almost as if the documentation should say "`[NSObject: AnyObject]` unless...".
